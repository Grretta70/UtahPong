<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utah Hockey Pong</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            background: #000000;
            color: #FFFFFF;
            text-align: center;
            font-family: 'Press Start 2P', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-linear-gradient(
                rgba(0, 0, 0, 0.1) 0,
                rgba(0, 0, 0, 0.1) 2px,
                transparent 2px,
                transparent 4px
            );
            pointer-events: none;
            z-index: 1;
        }
        body::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            z-index: 1;
        }
        #mainMenu, #playerCountMenu, #difficultySelect, #gameModeSelect, #teamSelect, #characterSelect, #preGameScreen, #gameContainer, #creditsModal, #victoryScreen, #pauseScreen, #optionsMenu {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
            position: relative;
            z-index: 10;
        }
        #playerCountMenu, #difficultySelect, #gameModeSelect, #teamSelect, #characterSelect, #preGameScreen, #gameContainer, #creditsModal, #victoryScreen, #pauseScreen, #optionsMenu {
            display: none;
            background: #000000;
        }
        #mainMenu {
            background: #000000;
            border: none;
            padding: 40px;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        #mainMenu h1 {
            font-size: 48px;
            color: #FFFFFF;
            text-shadow: 2px 2px 0 #4682B4;
            margin: 0 0 20px 0;
            animation: skateIn 1.5s ease-out forwards, subtleFlash 2s infinite;
        }
        @keyframes skateIn {
            0% { transform: translateX(-100%); opacity: 0; }
            80% { transform: translateX(10%); opacity: 1; }
            100% { transform: translateX(0); opacity: 1; }
        }
        @keyframes subtleFlash {
            0%, 100% { color: #FFFFFF; }
            50% { color: #4682B4; }
        }
        #mainMenu .menu-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        #creditsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000000;
            z-index: 1000;
        }
        #creditsImage {
            max-width: 80%;
            max-height: 80%;
            border: 4px solid #FFFFFF;
            image-rendering: pixelated;
        }
        #gameModeSelect .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        #characterSelect {
            background: #000000;
            padding: 20px;
            border: none;
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 10;
        }
        #characterSelect h2 {
            font-size: 24px;
            color: #FFFFFF;
            text-shadow: 2px 2px 0 #4682B4;
            margin-bottom: 20px;
        }
        #characterSelect .character-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            padding: 10px;
        }
        .character-option {
            background: #000000;
            border: 4px solid #4682B4;
            padding: 10px;
            cursor: pointer;
        }
        .character-option:hover {
            border-color: #FFFFFF;
        }
        .character-option.selected {
            border-color: #FFFFFF;
            background: #4682B4;
        }
        .character-option.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .character-option img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border: 2px solid #FFFFFF;
        }
        .character-option span {
            font-size: 12px;
            color: #FFFFFF;
            margin-top: 5px;
            text-shadow: 1px 1px 0 #000000;
        }
        #characterButtonContainer {
            margin-top: 30px;
            display: flex;
            gap: 30px;
        }
        #preGameScreen {
            background: #000000;
            border: none;
            padding: 40px;
            gap: 30px;
            max-width: 600px;
            margin: 0 auto;
        }
        #preGameScreen .player-info-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }
        #preGameScreen .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #preGameScreen .player-info img {
            width: 150px;
            height: 150px;
            image-rendering: pixelated;
            border: 4px solid #4682B4;
        }
        #preGameScreen .vs-text {
            font-size: 40px;
            color: #FFFFFF;
            text-shadow: 3px 3px 0 #4682B4;
            margin: 0 40px;
        }
        #gameContainer {
            background: #000000;
            padding: 20px;
            max-height: 100vh;
            position: relative;
        }
        #gameWrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        #scoreboard {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            width: 100%;
            max-width: 800px;
            background: #000000;
            border: 4px solid #FFFFFF;
            padding: 5px;
            margin-bottom: 10px;
            position: relative;
        }
        .player-info-score {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .player-info-score img {
            width: 50px;
            height: 50px;
            image-rendering: pixelated;
            border: 2px solid #FFFFFF;
        }
        #victoryScreen, #pauseScreen, #optionsMenu {
            background: #000000;
            border: none;
            width: 500px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
        }
        #victoryConfetti {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }
        .confetti {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: fall linear infinite;
        }
        #pauseScreen .hint {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 12px;
            color: #87CEEB;
            text-shadow: 1px 1px 0 #000000;
        }
        #victoryScreen h1, #pauseScreen h1, #optionsMenu h2 {
            font-size: 24px;
            color: #4682B4;
            text-shadow: 2px 2px 0 #000000;
            margin: 0 0 20px 0;
        }
        #victoryScreen h2, #pauseScreen h2 {
            margin: 0 0 20px 0;
            font-size: 28px;
            color: #FFFFFF;
            text-shadow: 2px 2px 0 #000000;
            animation: flashText 0.5s infinite;
        }
        @keyframes flashText {
            0%, 100% { color: #FFFFFF; }
            50% { color: #4682B4; }
        }
        #victoryScreen img {
            width: 200px;
            height: 200px;
            margin: 20px 0;
            image-rendering: pixelated;
            border: 4px solid #000000;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 400px;
        }
        button {
            margin: 10px 0;
            padding: 12px 18px;
            font-size: 14px;
            cursor: pointer;
            background-color: #000000;
            color: #FFFFFF;
            border: 4px solid #4682B4;
            font-family: 'Press Start 2P', sans-serif;
            min-width: 150px;
            text-shadow: 2px 2px 0 #000000;
            transition: background-color 0.2s, border-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        button:hover {
            background-color: #4682B4;
        }
        button:active {
            border-color: #FFFFFF;
        }
        canvas {
            margin: 0 auto;
            background: #000000;
            border: 4px solid #FFFFFF;
            padding: 5px;
            width: 100%;
            max-width: 800px;
            height: auto;
        }
        .notification-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 48px;
            color: #FFFFFF;
            text-shadow: 2px 2px 0 #000;
            z-index: 100;
            display: none;
        }
        .notification-text.flash {
            animation: flashHatTrick 0.5s infinite;
        }
        .notification-text.flashGoal {
            animation: flashGoal 1s infinite;
        }
        .notification-text.wildFlashHatTrick {
            animation: wildFlashHatTrick 0.5s infinite;
        }
        .notification-text.wildFlashGoal {
            animation: wildFlashGoal 1s infinite;
        }
        @keyframes flashHatTrick {
            0%, 100% { color: #FFFFFF; }
            50% { color: #4682B4; }
        }
        @keyframes flashGoal {
            0%, 100% { color: #FFFFFF; }
            50% { color: #87CEEB; }
        }
        @keyframes wildFlashHatTrick {
            0%, 100% { color: #A6192E; }
            50% { color: #FFD700; }
        }
        @keyframes wildFlashGoal {
            0%, 100% { color: #004C36; }
            50% { color: #A6192E; }
        }
        #tagline {
            font-size: 14px;
            color: #87CEEB;
            margin: 10px 0;
            font-family: 'Press Start 2P', sans-serif;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        #optionsMenu div {
            margin: 10px 0;
        }
        #optionsMenu label {
            font-size: 16px;
            color: #FFFFFF;
        }
        #optionsMenu input[type="range"] {
            width: 200px;
        }
        #optionsMenu input[type="range"]::-webkit-slider-runnable-track {
            background: #FFFFFF;
            height: 5px;
        }
        #optionsMenu input[type="range"]::-moz-range-track {
            background: #FFFFFF;
            height: 5px;
        }
        #optionsMenu input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 15px;
            height: 15px;
            background: #4682B4;
            cursor: pointer;
            border-radius: 50%;
        }
        #optionsMenu input[type="range"]::-moz-range-thumb {
            width: 15px;
            height: 15px;
            background: #4682B4;
            cursor: pointer;
            border-radius: 50%;
        }
        #snowflakes {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }
        .snowflake {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: fall linear infinite;
        }
        @keyframes fall {
            0% {
                transform: translateY(-10vh) translateX(0);
            }
            100% {
                transform: translateY(110vh) translateX(var(--sway));
            }
        }
        #versionText {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            color: #FFFFFF;
        }
        #playerTeamInfo, #opponentTeamInfo {
            width: 150px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            color: white;
            font-size: 12px;
            text-align: left;
        }
        .wildVictory {
            background: linear-gradient(to bottom, #FFD700, #A6192E);
        }
        .wildVictory h1 {
            color: #FFD700 !important;
        }
        .wildVictory h2 {
            color: #A6192E !important;
        }
    </style>
</head>
<body>
    <div id="mainMenu">
        <div id="snowflakes"></div>
        <h1>UTAH HOCKEY PONG</h1>
        <p id="tagline"></p>
        <div class="menu-buttons">
            <button onclick="playButtonSound(); showPlayerCountMenu()">START GAME</button>
            <button onclick="playButtonSound(); showCredits()">CREDITS</button>
            <button onclick="playButtonSound(); showOptions('mainMenu')">OPTIONS</button>
        </div>
    </div>
    <div id="playerCountMenu">
        <h2>START GAME</h2>
        <button onclick="playButtonSound(); showDifficultySelect()">1 PLAYER</button>
        <button onclick="playButtonSound(); showGameModeSelect2Player()">2 PLAYERS</button>
        <button onclick="playButtonSound(); goBackToMainMenu()">BACK</button>
    </div>
    <div id="creditsModal">
        <img id="creditsImage" src="https://github.com/Grretta70/UtahPong/blob/main/1.png?raw=true" alt="Credits">
        <button id="closeCreditsButton" onclick="playButtonSound(); hideCredits()">CLOSE</button>
    </div>
    <div id="difficultySelect">
        <h2>SELECT DIFFICULTY</h2>
        <button onclick="playButtonSound(); setDifficulty('rookie'); showGameModeSelect()">ROOKIE</button>
        <button onclick="playButtonSound(); setDifficulty('ahl'); showGameModeSelect()">AHL</button>
        <button onclick="playButtonSound(); setDifficulty('nhl'); showGameModeSelect()">NHL</button>
        <button onclick="playButtonSound(); goBackToPlayerCount()">BACK</button>
    </div>
    <div id="gameModeSelect">
        <h2 id="gameModeTitle">GAME MODE</h2>
        <div class="mode-grid" id="modeGrid"></div>
        <button onclick="playButtonSound(); goBackToPlayerCount()">BACK</button>
    </div>
    <div id="teamSelect">
        <h2>SELECT OPPONENT TEAM</h2>
        <button onclick="playButtonSound(); selectTeam('Grizzlies'); startCharacterSelect(5)">
            <img src="https://github.com/Grretta70/UtahPong/blob/main/GrizzliesLogo.png?raw=true" alt="Grizzlies" style="width: 50px; height: 50px;">
            GRIZZLIES
        </button>
        <button onclick="playButtonSound(); selectTeam('Yeti'); startCharacterSelect(5)">
            <img src="https://github.com/Grretta70/UtahPong/blob/main/YetiLogo.png?raw=true" alt="Yeti" style="width: 50px; height: 50px;">
            YETI
        </button>
        <button onclick="playButtonSound(); selectTeam('Minnesota Wild'); startCharacterSelect(5)">
            <img src="https://github.com/Grretta70/UtahPong/blob/main/WildLogo.png?raw=true" alt="Minnesota Wild" style="width: 50px; height: 50px;">
            MINNESOTA WILD
        </button>
        <button onclick="playButtonSound(); goBackToGameModeSelect()">BACK</button>
    </div>
    <div id="characterSelect">
        <h2 id="characterSelectTitle"></h2>
        <div class="character-container">
            <div class="character-option" onclick="selectCharacter('Clayton Keller', this.querySelector('img'))">
                <img src="https://github.com/Grretta70/UtahPong/blob/main/ClaytonKeller_processed.png?raw=true" onerror="this.src='fallback.png'">
                <span>CLAYTON KELLER</span>
            </div>
            <div class="character-option" onclick="selectCharacter('Logan Cooley', this.querySelector('img'))">
                <img src="https://github.com/Grretta70/UtahPong/blob/main/LoganCooley_processed.png?raw=true" onerror="this.src='fallback.png'">
                <span>LOGAN COOLEY</span>
            </div>
            <div class="character-option" onclick="selectCharacter('Dylan Guenther', this.querySelector('img'))">
                <img src="https://github.com/Grretta70/UtahPong/blob/main/DylanGuenther_processed.png?raw=true" onerror="this.src='fallback.png'">
                <span>DYLAN GUENTHER</span>
            </div>
            <div class="character-option" onclick="selectCharacter('Michael Kesselring', this.querySelector('img'))">
                <img src="https://github.com/Grretta70/UtahPong/blob/main/MichaelKesselring_processed.png?raw=true" onerror="this.src='fallback.png'">
                <span>MICHAEL KESSELRING</span>
            </div>
            <div class="character-option" onclick="selectCharacter('Liam O\'Brien', this.querySelector('img'))">
                <img src="https://github.com/Grretta70/UtahPong/blob/main/LiamObrein_processed.png?raw=true" onerror="this.src='fallback.png'">
                <span>LIAM O'BRIEN</span>
            </div>
            <div class="character-option" onclick="selectCharacter('Olli Määtä', this.querySelector('img'))">
                <img src="https://github.com/Grretta70/UtahPong/blob/main/OlliMaatta-removebg-preview.png?raw=true" onerror="this.src='fallback.png'">
                <span>OLLI MÄÄTTÄ</span>
            </div>
        </div>
        <div id="characterButtonContainer">
            <button id="backButton" onclick="playButtonSound(); goBackToGameModeSelect()">BACK</button>
            <button id="confirmButton" onclick="playButtonSound(); confirmCharacterSelection()" style="display: none;">CONFIRM</button>
        </div>
    </div>
    <div id="preGameScreen">
        <div class="player-info-container">
            <div class="player-info">
                <img id="player1PreGameIcon" src="" alt="Player 1 Icon">
                <span id="player1PreGameName"></span>
            </div>
            <span class="vs-text">VS</span>
            <div class="player-info">
                <img id="player2PreGameIcon" src="" alt="Player 2 Icon">
                <span id="player2PreGameName"></span>
            </div>
        </div>
        <button id="dropPuckButton" onclick="playButtonSound(); startPuckDrop()">DROP THE PUCK!</button>
    </div>
    <div id="gameContainer">
        <div id="scoreboard">
            <div class="player-info-score" id="player1Scoreboard">
                <img id="player1IconScore" src="" alt="Player 1 Icon">
                <span id="player1NameScore"></span>
                <span id="player1Score">0</span>
            </div>
            <div class="notification-text" id="notificationText"></div>
            <div class="player-info-score" id="player2Scoreboard">
                <img id="player2IconScore" src="" alt="Player 2 Icon">
                <span id="player2NameScore"></span>
                <span id="player2Score">0</span>
            </div>
        </div>
        <div id="gameWrapper">
            <div id="playerTeamInfo">
                <h3>Utah Hockey Club</h3>
                <div id="playerStats"></div>
                <div id="playerSwapIndicator"></div>
            </div>
            <canvas id="gameCanvas" width="800" height="400"></canvas>
            <div id="opponentTeamInfo">
                <h3>Opponent</h3>
                <div id="opponentStats"></div>
                <div id="opponentSwapIndicator"></div>
            </div>
        </div>
    </div>
    <div id="victoryScreen">
        <div id="victoryConfetti"></div>
        <h1 id="victoryHeader">WINNER!</h1>
        <h2 id="victoryMessage"></h2>
        <img id="victoryIcon" src="" alt="Winner Icon">
        <div class="button-grid">
            <button onclick="playButtonSound(); returnToGameModeSelect()">GAME MODES</button>
            <button onclick="playButtonSound(); returnToMainMenu()">MAIN MENU</button>
            <button onclick="playButtonSound(); replayGame()">REPLAY</button>
            <button onclick="playButtonSound(); showCredits()">CREDITS</button>
        </div>
    </div>
    <div id="pauseScreen">
        <h1>PAUSED</h1>
        <div class="hint">Press 'P' to Pause/Resume</div>
        <div class="button-grid">
            <button onclick="playButtonSound(); togglePause()">RESUME</button>
            <button onclick="playButtonSound(); showOptions('pauseScreen')">OPTIONS</button>
            <button onclick="playButtonSound(); endGameToMainMenu()">MAIN MENU</button>
            <button onclick="playButtonSound(); endGameToGameModeSelect()">GAME MODES</button>
        </div>
    </div>
    <div id="optionsMenu">
        <h2>OPTIONS</h2>
        <div>
            <label for="musicVolumeSlider">Music Volume:</label>
            <input type="range" id="musicVolumeSlider" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div>
            <label for="boopVolumeSlider">Boop Volume:</label>
            <input type="range" id="boopVolumeSlider" min="0" max="1" step="0.1" value="0.3">
        </div>
        <div>
            <button id="muteBoopsButton">Mute Boops</button>
        </div>
        <p id="versionText">Version Alpha 1.0</p>
        <button onclick="playButtonSound(); goBackFromOptions()">BACK</button>
    </div>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ballSize = 20;
        const initialPuckSize = 250;

        let leftPaddleY = 150;
        let rightPaddleY = 150;
        let ballX = canvas.width / 2;
        let ballY = canvas.height / 2;
        let ballSpeedX = 0;
        let ballSpeedY = 0;
        let paddleHeight = 70;
        let paddleWidth = 10;
        let leftScore = 0;
        let rightScore = 0;
        let gameRunning = false;
        let gameStarted = false;
        let leftPaddleDY = 0;
        let rightPaddleDY = 0;
        let aiPaddleSpeed = 300;
        let aiOffset = 50;
        let isTwoPlayer = false;
        let isPenaltyShot = false;
        let isTeamMode = false;
        let goalY = 150;
        let goalHeight = 100;
        let goalSpeed = 200;
        let goalAmplitude = 100;
        let goalFrequency = 1;
        let misses = 0;
        let lastScorer = null;

        const paddleSpeed = 360;
        let maxBallSpeed = 500;

        let player1Character = null;
        let player2Character = null;
        let goaltenderCharacter = null;
        let selectionState = 'player1';
        let winningScore = 0;
        let prevTime = performance.now();

        let goalFlashTime = 0;
        const goalFlashDuration = 1.5;
        let hatTrickFlashTime = 0;
        const hatTrickFlashDuration = 2.0;
        let scoreFlashTime = 0;
        const scoreFlashDuration = 0.5;
        let confettiActive = false;
        let confettiParticles = [];

        let scratchOffset = 0;
        const ballTrail = [];

        let musicVolume = 0.3;
        let boopVolume = 0.3;
        let boopMuted = false;
        let previousMenu = null;

        let selectedOpponent = null;
        let playerRoster = [];
        let opposingRoster = [];
        let activePlayerIndex = 0;
        let activeOppPlayerIndex = 0;
        let lastSwapTime = 0;
        let tempSelectedCharacter = null;

        const mainMenuMusic = new Audio('https://raw.githubusercontent.com/Grretta70/UtahPong/main/Ice%20Breakers.mp3');
        mainMenuMusic.loop = true;
        mainMenuMusic.volume = musicVolume;

        const gameMusic = new Audio('https://raw.githubusercontent.com/Grretta70/UtahPong/main/Ice%20Rink%20Rebels.mp3');
        gameMusic.loop = true;
        gameMusic.volume = musicVolume;

        const victoryMusic = new Audio('https://raw.githubusercontent.com/Grretta70/UtahPong/main/Pixelated%20Triumph.mp3');
        victoryMusic.volume = musicVolume;

        const loseMusic = new Audio('https://raw.githubusercontent.com/Grreta70/UtahPong/main/Frozen%20Glory.mp3');
        loseMusic.volume = musicVolume;

        const characters = [
            { name: "Clayton Keller", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/ClaytonKeller_processed.png?raw=true", locked: false },
            { name: "Logan Cooley", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/LoganCooley_processed.png?raw=true", locked: false },
            { name: "Dylan Guenther", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/DylanGuenther_processed.png?raw=true", locked: false },
            { name: "Michael Kesselring", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/MichaelKesselring_processed.png?raw=true", locked: false },
            { name: "Liam O'Brien", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/LiamObrein_processed.png?raw=true", locked: false },
            { name: "Olli Määtä", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/OlliMaatta-removebg-preview.png?raw=true", locked: false }
        ];

        const goaltenders = [
            { name: "Karel Vejmelka", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/Karel%20Vejmelka.jpeg?raw=true" },
            { name: "Conner Ingram", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/ConnerIngram.png?raw=true" }
        ];

        const teams = {
            "Grizzlies": [
                { name: "Clayton Keller", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/ClaytonKeller_processed.png?raw=true" },
                { name: "Logan Cooley", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/LoganCooley_processed.png?raw=true" },
                { name: "Dylan Guenther", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/DylanGuenther_processed.png?raw=true" }
            ],
            "Yeti": [
                { name: "Michael Kesselring", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/MichaelKesselring_processed.png?raw=true" },
                { name: "Liam O'Brien", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/LiamObrein_processed.png?raw=true" },
                { name: "Olli Määtä", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/OlliMaatta-removebg-preview.png?raw=true" }
            ],
            "Minnesota Wild": [
                { name: "Jared Spurgeon", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/Jared-Spurgeon.png?raw=true" },
                { name: "Kirill Kaprizov", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/Karill-Kaprizov.png?raw=true" },
                { name: "Brock Faber", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/Brock-Faber.png?raw=true" }
            ]
        };

        const teamLogos = {
            "Utah Hockey Club": "https://github.com/Grretta70/UtahPong/blob/main/UtahLogo.png?raw=true",
            "Grizzlies": "https://github.com/Grretta70/UtahPong/blob/main/GrizzliesLogo.png?raw=true",
            "Yeti": "https://github.com/Grretta70/UtahPong/blob/main/YetiLogo.png?raw=true",
            "Minnesota Wild": "https://github.com/Grretta70/UtahPong/blob/main/WildLogo.png?raw=true"
        };

        const centerIceLogo = new Image();
        centerIceLogo.src = "https://github.com/Grretta70/UtahPong/blob/main/CenterIceLogoPixelated.jpg?raw=true";

        const puckImage = new Image();
        puckImage.src = "https://github.com/Grretta70/UtahPong/blob/main/UTAH%20Hockey%20Puck.png?raw=true";

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        let puckDropActive = false;
        let puckDropStartTime = 0;
        let puckDropDuration = 4000;

        const taglines = [
            "Glass rattling saves not included.",
            "Zamboni not required.",
            "Now with 100% more puck physics!",
            "Mind the five-hole.",
            "Boards, bounces, and bruises.",
            "Just like hockey, but with angles.",
            "Goalies hate this one weird trick!",
            "No icing, just precision.",
            "Play like it’s Game 7.",
            "Built for breakaways and bounces.",
            "Puck physics defy logic!",
            "Goalie pads sold separately.",
            "Now with 87% more rebounds!",
            "Where angles are everything.",
            "Five-hole: the final frontier.",
            "Built for bank shots and breakaways.",
            "Boards don’t hit back. Unless they do.",
            "Real hockey? This is real hockey.",
            "Zamboni not included.",
            "You miss 100% of the pongs you don’t play.",
            "One does not simply clear the zone.",
            "Paddle faster, they’re coming!",
            "Go bar down, or go home.",
            "It’s not high-sticking if no one calls it.",
            "Spin-o-rama not recommended.",
            "You versus the laws of physics.",
            "Deflections: friend or foe?",
            "The puck has a mind of its own.",
            "They don’t ask how, they ask how many.",
            "Face-offs: now 200% more intense!"
        ];

        document.getElementById('tagline').textContent = taglines[Math.floor(Math.random() * taglines.length)];

        function playButtonSound() {
            playSound(440, 0.1);
        }

        function playSound(frequency, duration, volume = boopVolume) {
            if (boopMuted) return;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();
            oscillator.type = 'square';
            oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
            gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            oscillator.start();
            oscillator.stop(audioCtx.currentTime + duration);
        }

        function playGoalSound() {
            playSound(600, 0.1);
            setTimeout(() => playSound(800, 0.1), 100);
            setTimeout(() => playSound(1000, 0.1), 200);
        }

        function playHatTrickSound() {
            const frequencies = [600, 700, 800, 900, 1000, 1100];
            frequencies.forEach((freq, index) => {
                setTimeout(() => playSound(freq, 0.05), index * 100);
            });
        }

        function playSadBeepBoop() {
            playSound(300, 0.1);
            setTimeout(() => playSound(200, 0.1), 100);
        }

        function playMainMenuMusic() {
            gameMusic.pause();
            victoryMusic.pause();
            loseMusic.pause();
            victoryMusic.currentTime = 0;
            loseMusic.currentTime = 0;
            if (mainMenuMusic.paused) {
                mainMenuMusic.play().catch(error => {
                    console.log("Autoplay prevented:", error);
                    document.addEventListener('click', () => mainMenuMusic.play(), { once: true });
                });
            }
        }

        function playGameMusic() {
            mainMenuMusic.pause();
            victoryMusic.pause();
            loseMusic.pause();
            victoryMusic.currentTime = 0;
            loseMusic.currentTime = 0;
            if (gameMusic.paused) {
                gameMusic.play();
            }
        }

        function playVictoryMusic() {
            mainMenuMusic.pause();
            gameMusic.pause();
            loseMusic.pause();
            loseMusic.currentTime = 0;
            if (victoryMusic.paused) {
                victoryMusic.currentTime = 0;
                victoryMusic.play().catch(error => {
                    console.log("Autoplay prevented for victory music:", error);
                    document.addEventListener('click', () => victoryMusic.play(), { once: true });
                });
            }
        }

        function playLoseMusic() {
            mainMenuMusic.pause();
            gameMusic.pause();
            victoryMusic.pause();
            victoryMusic.currentTime = 0;
            if (loseMusic.paused) {
                loseMusic.currentTime = 0;
                loseMusic.play().catch(error => {
                    console.log("Autoplay prevented for lose music:", error);
                    document.addEventListener('click', () => loseMusic.play(), { once: true });
                });
            }
        }

        function showCredits() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('creditsModal').style.display = 'flex';
            clearButtonGlow();
        }

        function hideCredits() {
            document.getElementById('creditsModal').style.display = 'none';
            if (document.getElementById('victoryScreen').style.display === 'none') {
                document.getElementById('mainMenu').style.display = 'flex';
            } else {
                document.getElementById('victoryScreen').style.display = 'flex';
            }
            clearButtonGlow();
        }

        function showPlayerCountMenu() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('playerCountMenu').style.display = 'flex';
            clearButtonGlow();
        }

        function goBackToMainMenu() {
            document.getElementById('playerCountMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            clearButtonGlow();
            playMainMenuMusic();
        }

        function showDifficultySelect() {
            document.getElementById('playerCountMenu').style.display = 'none';
            document.getElementById('difficultySelect').style.display = 'flex';
            clearButtonGlow();
        }

        function goBackToPlayerCount() {
            document.getElementById('difficultySelect').style.display = 'none';
            document.getElementById('teamSelect').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'none';
            document.getElementById('playerCountMenu').style.display = 'flex';
            clearButtonGlow();
        }

        function setDifficulty(level) {
            switch (level) {
                case 'rookie':
                    aiPaddleSpeed = 200;
                    aiOffset = 50;
                    maxBallSpeed = 600;
                    goalSpeed = 150;
                    goalAmplitude = 50;
                    goalFrequency = 0.5;
                    break;
                case 'ahl':
                    aiPaddleSpeed = 350;
                    aiOffset = 40;
                    maxBallSpeed = 700;
                    goalSpeed = 200;
                    goalAmplitude = 75;
                    goalFrequency = 1;
                    break;
                case 'nhl':
                    aiPaddleSpeed = 500;
                    aiOffset = 20;
                    maxBallSpeed = 800;
                    goalSpeed = 250;
                    goalAmplitude = 100;
                    goalFrequency = 1.5;
                    break;
            }
        }

        function showGameModeSelect() {
            document.getElementById('difficultySelect').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            document.getElementById('gameModeTitle').textContent = '1 PLAYER MODES';
            const modeGrid = document.getElementById('modeGrid');
            modeGrid.innerHTML = '';
            // Removed 'Team vs. Team'
            const points = ['3 Points', '5 Points', '10 Points', 'Penalty Shot', 'Sudden Death'];
            points.forEach(point => {
                const btn = document.createElement('button');
                btn.textContent = point;
                btn.onclick = () => {
                    playButtonSound();
                    toggleSelected(btn);
                    isTeamMode = false;
                    isTwoPlayer = false;
                    isPenaltyShot = (point === 'Penalty Shot');
                    startCharacterSelect(point === 'Sudden Death' || point === 'Penalty Shot' ? 1 : parseInt(point));
                };
                modeGrid.appendChild(btn);
            });
            clearButtonGlow();
        }

        function showGameModeSelect2Player() {
            document.getElementById('playerCountMenu').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            document.getElementById('gameModeTitle').textContent = '2 PLAYER MODES';
            const modeGrid = document.getElementById('modeGrid');
            modeGrid.innerHTML = '';
            const points = ['3 Points', '5 Points', '10 Points', 'Sudden Death'];
            points.forEach(point => {
                const btn = document.createElement('button');
                btn.textContent = point;
                btn.onclick = () => {
                    playButtonSound();
                    toggleSelected(btn);
                    isTeamMode = false;
                    isTwoPlayer = true;
                    isPenaltyShot = false;
                    startCharacterSelect(point === 'Sudden Death' ? 1 : parseInt(point));
                };
                modeGrid.appendChild(btn);
            });
            clearButtonGlow();
        }

        function showTeamSelect() {
            document.getElementById('gameModeSelect').style.display = 'none';
            document.getElementById('teamSelect').style.display = 'flex';
            clearButtonGlow();
        }

        function goBackToGameModeSelect() {
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('teamSelect').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            if (isTwoPlayer) showGameModeSelect2Player();
            else showGameModeSelect();
            clearButtonGlow();
        }

        function selectTeam(teamName) {
            selectedOpponent = teamName;
            opposingRoster = teams[teamName].map(player => ({ ...player, stats: { goals: 0, paddleHits: 0 } }));
            startCharacterSelect(5); // Winning score set to 5 for Team vs. Team
        }

        function startCharacterSelect(points) {
            winningScore = points;
            document.getElementById('gameModeSelect').style.display = 'none';
            document.getElementById('teamSelect').style.display = 'none';
            document.getElementById('characterSelect').style.display = 'flex';
            if (isTeamMode) {
                playerRoster = [];
                selectionState = 'player1';
                document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 1 FOR YOUR TEAM';
            } else {
                selectionState = 'player1';
                document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 1';
            }
            characters.forEach(character => character.locked = false);
            document.querySelectorAll('.character-option').forEach(option => {
                option.classList.remove('selected');
                option.classList.remove('locked');
            });
            document.getElementById('confirmButton').style.display = 'none';
            tempSelectedCharacter = null;
            clearButtonGlow();
        }

        function returnToGameModeSelect() {
            document.getElementById('victoryScreen').style.display = 'none';
            victoryMusic.pause();
            loseMusic.pause();
            victoryMusic.currentTime = 0;
            loseMusic.currentTime = 0;
            goBackToGameModeSelect();
            playMainMenuMusic();
            clearButtonGlow();
        }

        function returnToMainMenu() {
            document.getElementById('victoryScreen').style.display = 'none';
            victoryMusic.pause();
            loseMusic.pause();
            victoryMusic.currentTime = 0;
            loseMusic.currentTime = 0;
            document.getElementById('mainMenu').style.display = 'flex';
            clearButtonGlow();
            playMainMenuMusic();
        }

        function replayGame() {
            document.getElementById('victoryScreen').style.display = 'none';
            victoryMusic.pause();
            loseMusic.pause();
            victoryMusic.currentTime = 0;
            loseMusic.currentTime = 0;
            startPuckDrop();
        }

        function toggleSelected(button) {
            const parent = button.parentElement;
            const buttons = parent.querySelectorAll('button');
            buttons.forEach(btn => btn.classList.remove('selected'));
            button.classList.add('selected');
        }

        function clearButtonGlow() {
            document.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
        }

        function showPreGameScreen() {
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('preGameScreen').style.display = 'flex';
            document.getElementById('player1PreGameIcon').src = player1Character.imgSrc;
            document.getElementById('player1PreGameName').textContent = player1Character.name;
            document.getElementById('player2PreGameIcon').src = isPenaltyShot ? goaltenderCharacter.imgSrc : player2Character.imgSrc;
            document.getElementById('player2PreGameName').textContent = isPenaltyShot ? goaltenderCharacter.name : player2Character.name;
            clearButtonGlow();
        }

        function showPreGameScreenForTeamMode() {
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('preGameScreen').style.display = 'flex';
            document.getElementById('player1PreGameIcon').src = teamLogos["Utah Hockey Club"];
            document.getElementById('player1PreGameName').textContent = "Utah Hockey Club";
            document.getElementById('player2PreGameIcon').src = teamLogos[selectedOpponent];
            document.getElementById('player2PreGameName').textContent = selectedOpponent;
            clearButtonGlow();
        }

        function startPuckDrop() {
            document.getElementById('preGameScreen').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'flex';
            leftScore = 0;
            rightScore = 0;
            misses = 0;
            ballTrail.length = 0;
            scratchOffset = 0;
            if (isTeamMode) {
                activePlayerIndex = 0;
                activeOppPlayerIndex = 0;
                lastSwapTime = performance.now();
                document.getElementById('player1IconScore').src = playerRoster[0].imgSrc;
                document.getElementById('player1NameScore').textContent = getLastName(playerRoster[0].name);
                document.getElementById('player2IconScore').src = opposingRoster[0].imgSrc;
                document.getElementById('player2NameScore').textContent = getLastName(opposingRoster[0].name);
                document.getElementById('playerTeamInfo').innerHTML = `<h3>Utah Hockey Club</h3><div id="playerStats"></div><div id="playerSwapIndicator"></div>`;
                document.getElementById('opponentTeamInfo').innerHTML = `<h3>${selectedOpponent}</h3><div id="opponentStats"></div><div id="opponentSwapIndicator"></div>`;
                document.getElementById('playerTeamInfo').style.display = 'block';
                document.getElementById('opponentTeamInfo').style.display = 'block';
                updateStats();
            } else {
                document.getElementById('player1IconScore').src = player1Character.imgSrc;
                document.getElementById('player1NameScore').textContent = getLastName(player1Character.name);
                document.getElementById('player2IconScore').src = isPenaltyShot ? goaltenderCharacter.imgSrc : player2Character.imgSrc;
                document.getElementById('player2NameScore').textContent = isPenaltyShot ? getLastName(goaltenderCharacter.name) : getLastName(player2Character.name);
                document.getElementById('playerTeamInfo').style.display = 'none';
                document.getElementById('opponentTeamInfo').style.display = 'none';
            }
            document.getElementById('player1Score').textContent = leftScore;
            document.getElementById('player2Score').textContent = isPenaltyShot ? misses : rightScore;
            resetBall();
            gameRunning = true;
            puckDropActive = true;
            puckDropStartTime = performance.now();
            goalFlashTime = 0;
            hatTrickFlashTime = 0;
            scoreFlashTime = 0;
            confettiActive = false;
            confettiParticles = [];
            playGameMusic();
            requestAnimationFrame((timestamp) => {
                prevTime = timestamp;
                gameLoop(timestamp);
            });
        }

        function startCountdown() {
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = "3";
            notificationText.style.display = 'block';
            playSound(500, 0.1);
            setTimeout(() => {
                notificationText.textContent = "2";
                playSound(500, 0.1);
                setTimeout(() => {
                    notificationText.textContent = "1";
                    playSound(500, 0.1);
                    setTimeout(() => {
                        notificationText.style.display = 'none';
                        gameRunning = true;
                        gameMusic.play();
                        requestAnimationFrame((timestamp) => {
                            prevTime = timestamp;
                            gameLoop(timestamp);
                        });
                    }, 1000);
                }, 1000);
            }, 1000);
        }

        function togglePause() {
            if (!gameRunning && document.getElementById('pauseScreen').style.display === 'flex') {
                document.getElementById('pauseScreen').style.display = 'none';
                document.getElementById('gameContainer').style.display = 'flex';
                startCountdown();
            } else if (gameRunning) {
                gameRunning = false;
                gameMusic.pause();
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('pauseScreen').style.display = 'flex';
            }
            clearButtonGlow();
        }

        function endGameToMainMenu() {
            gameRunning = false;
            gameMusic.pause();
            document.getElementById('pauseScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            playMainMenuMusic();
            clearButtonGlow();
        }

        function endGameToGameModeSelect() {
            gameRunning = false;
            gameMusic.pause();
            document.getElementById('pauseScreen').style.display = 'none';
            goBackToGameModeSelect();
            playMainMenuMusic();
            clearButtonGlow();
        }

        function showOptions(fromMenu) {
            previousMenu = fromMenu;
            document.getElementById(fromMenu).style.display = 'none';
            document.getElementById('optionsMenu').style.display = 'flex';
            document.getElementById('musicVolumeSlider').value = musicVolume;
            document.getElementById('boopVolumeSlider').value = boopVolume;
            document.getElementById('muteBoopsButton').textContent = boopMuted ? "Unmute Boops" : "Mute Boops";
        }

        function goBackFromOptions() {
            document.getElementById('optionsMenu').style.display = 'none';
            document.getElementById(previousMenu).style.display = 'flex';
            previousMenu = null;
        }

        document.getElementById('musicVolumeSlider').addEventListener('input', function() {
            musicVolume = parseFloat(this.value);
            mainMenuMusic.volume = musicVolume;
            gameMusic.volume = musicVolume;
            victoryMusic.volume = musicVolume;
            loseMusic.volume = musicVolume;
        });

        document.getElementById('boopVolumeSlider').addEventListener('input', function() {
            boopVolume = parseFloat(this.value);
        });

        document.getElementById('muteBoopsButton').addEventListener('click', function() {
            boopMuted = !boopMuted;
            this.textContent = boopMuted ? "Unmute Boops" : "Mute Boops";
        });

        document.addEventListener("keydown", function(event) {
            if (document.getElementById('mainMenu').style.display !== 'none') {
                playButtonSound();
                showPlayerCountMenu();
                return;
            }
            if (event.key === 'p' && document.getElementById('gameContainer').style.display === 'flex') {
                playButtonSound();
                togglePause();
                return;
            }
            if (event.key === "w") leftPaddleDY = -paddleSpeed;
            if (event.key === "s") leftPaddleDY = paddleSpeed;
            if (isTwoPlayer) {
                if (event.key === "ArrowUp") rightPaddleDY = -paddleSpeed;
                if (event.key === "ArrowDown") rightPaddleDY = paddleSpeed;
            }
        });

        document.addEventListener("keyup", function(event) {
            if (event.key === "w" || event.key === "s") leftPaddleDY = 0;
            if (isTwoPlayer && (event.key === "ArrowUp" || event.key === "ArrowDown")) rightPaddleDY = 0;
        });

        function selectCharacter(character, element) {
            const selectedCharacter = characters.find(c => c.name === character);
            if (selectedCharacter.locked) return;
            document.querySelectorAll('.character-option').forEach(option => {
                option.classList.remove('selected');
            });
            element.parentElement.classList.add('selected');
            tempSelectedCharacter = { name: character, imgSrc: element.src };
            playSound(600, 0.05);
            if (isTeamMode) {
                document.getElementById('characterSelectTitle').textContent = 'PLAYER ' + (playerRoster.length + 1) + ': CONFIRM';
            } else {
                document.getElementById('characterSelectTitle').textContent = selectionState.toUpperCase() + ': CONFIRM';
            }
            document.getElementById('confirmButton').style.display = 'inline-block';
        }

        function confirmCharacterSelection() {
            if (tempSelectedCharacter) {
                characters.find(c => c.name === tempSelectedCharacter.name).locked = true;
                document.querySelectorAll('.character-option').forEach(option => {
                    if (option.querySelector('span').textContent === tempSelectedCharacter.name) {
                        option.classList.add('selected');
                        option.classList.add('locked');
                    }
                });
                if (isTeamMode) {
                    playerRoster.push({ ...tempSelectedCharacter, stats: { goals: 0, paddleHits: 0 } });
                    if (playerRoster.length < 3) {
                        selectionState = 'player' + (playerRoster.length + 1);
                        document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER ' + (playerRoster.length + 1) + ' FOR YOUR TEAM';
                        document.querySelectorAll('.character-option').forEach(option => option.classList.remove('selected'));
                        tempSelectedCharacter = null;
                        document.getElementById('confirmButton').style.display = 'none';
                    } else {
                        showPreGameScreenForTeamMode();
                    }
                } else if (isTwoPlayer) {
                    if (selectionState === 'player1') {
                        player1Character = tempSelectedCharacter;
                        selectionState = 'player2';
                        document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 2';
                        document.querySelectorAll('.character-option').forEach(option => option.classList.remove('selected'));
                        tempSelectedCharacter = null;
                        document.getElementById('confirmButton').style.display = 'none';
                    } else if (selectionState === 'player2') {
                        player2Character = tempSelectedCharacter;
                        showPreGameScreen();
                    }
                } else {
                    player1Character = tempSelectedCharacter;
                    if (isPenaltyShot) {
                        goaltenderCharacter = goaltenders[Math.floor(Math.random() * goaltenders.length)];
                    } else {
                        const availableCharacters = characters.filter(c => c.imgSrc !== player1Character.imgSrc);
                        player2Character = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
                    }
                    showPreGameScreen();
                }
            }
        }

        function getLastName(fullName) {
            const nameParts = fullName.split(' ');
            return nameParts[nameParts.length - 1];
        }

        function resetBall(currentTime = performance.now()) {
            ballX = canvas.width / 2;
            ballY = canvas.height / 2;
            ballSpeedX = 0;
            ballSpeedY = 0;
            gameStarted = false;
            puckDropActive = true;
            puckDropStartTime = currentTime;
            ballTrail.length = 0;
        }

        function createVictoryConfetti(colors) {
            const confettiContainer = document.getElementById('victoryConfetti');
            confettiContainer.innerHTML = '';
            const numberOfConfetti = 100;
            for (let i = 0; i < numberOfConfetti; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.animationDuration = `${Math.random() * 3 + 2}s`;
                confetti.style.animationDelay = `-${Math.random() * 5}s`;
                confetti.style.opacity = Math.random();
                confetti.style.width = `${Math.random() * 10 + 5}px`; // Larger confetti: 5px to 15px
                confetti.style.height = confetti.style.width;
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.setProperty('--sway', `${Math.random() * 20 - 10}vw`);
                confettiContainer.appendChild(confetti);
            }
        }

        function showVictoryScreen(winner) {
            gameRunning = false;
            document.getElementById('gameContainer').style.display = 'none';
            document.getElementById('victoryScreen').style.display = 'flex';
            document.getElementById('victoryHeader').style.display = 'block';
            if (isTeamMode) {
                if (winner === 'left') {
                    document.getElementById('victoryMessage').textContent = "UTAH HOCKEY CLUB WINS!";
                    document.getElementById('victoryIcon').src = teamLogos["Utah Hockey Club"];
                    document.getElementById('victoryIcon').style.width = '200px';
                    document.getElementById('victoryIcon').style.height = '200px';
                    document.getElementById('victoryScreen').classList.remove('wildVictory');
                    document.getElementById('victoryConfetti').innerHTML = '';
                } else {
                    const opponentName = selectedOpponent;
                    document.getElementById('victoryMessage').textContent = opponentName === "Minnesota Wild" ? "MINNESOTA WILD WINS!" : `${opponentName.toUpperCase()} WINS!`;
                    document.getElementById('victoryIcon').src = teamLogos[opponentName];
                    if (opponentName === "Minnesota Wild") {
                        document.getElementById('victoryIcon').style.width = '300px';
                        document.getElementById('victoryIcon').style.height = '300px';
                        document.getElementById('victoryScreen').classList.add('wildVictory');
                        createVictoryConfetti(['#004C36', '#A6192E', '#FFD700']);
                    } else {
                        document.getElementById('victoryIcon').style.width = '200px';
                        document.getElementById('victoryIcon').style.height = '200px';
                        document.getElementById('victoryScreen').classList.remove('wildVictory');
                        document.getElementById('victoryConfetti').innerHTML = '';
                    }
                }
            } else {
                if (winner === 'left') {
                    document.getElementById('victoryMessage').textContent = `${player1Character.name} WINS!`;
                    document.getElementById('victoryIcon').src = player1Character.imgSrc;
                } else {
                    document.getElementById('victoryMessage').textContent = `${player2Character.name} WINS!`;
                    document.getElementById('victoryIcon').src = player2Character.imgSrc;
                }
                document.getElementById('victoryIcon').style.width = '200px';
                document.getElementById('victoryIcon').style.height = '200px';
                document.getElementById('victoryScreen').classList.remove('wildVictory');
                document.getElementById('victoryConfetti').innerHTML = '';
            }
            playVictoryMusic();
        }

        function drawFaceOffCircles() {
            const radius = 60;
            const positions = [
                { x: 80, y: 80 },
                { x: 80, y: 320 },
                { x: 720, y: 80 },
                { x: 720, y: 320 }
            ];

            positions.forEach(pos => {
                ctx.beginPath();
                ctx.arc(pos.x, pos.y, radius, 0, Math.PI * 2);
                ctx.strokeStyle = '#4682B4';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.stroke();
                ctx.setLineDash([]);
                ctx.fillStyle = '#800000';
                ctx.fillRect(pos.x - 5, pos.y - 5, 10, 10);
            });
        }

        function createConfetti(colors = ['#4682B4', '#FFFFFF', '#000000']) {
            confettiActive = true;
            confettiParticles = [];
            for (let i = 0; i < 100; i++) {
                confettiParticles.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * canvas.height - 200,
                    color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 10 + 5,
                    speedY: Math.random() * 5 + 2,
                    speedX: Math.random() * 4 - 2,
                    rotation: Math.random() * 360
                });
            }
        }

        function drawConfetti() {
            if (!confettiActive) return;
            confettiParticles.forEach((particle, index) => {
                ctx.save();
                ctx.translate(particle.x, particle.y);
                ctx.rotate(particle.rotation * Math.PI / 180);
                ctx.fillStyle = particle.color;
                ctx.fillRect(-particle.size / 2, -particle.size / 2, particle.size, particle.size);
                ctx.restore();
                particle.y += particle.speedY;
                particle.x += particle.speedX;
                particle.rotation += 5;
                if (particle.y > canvas.height) {
                    confettiParticles.splice(index, 1);
                }
            });
            if (confettiParticles.length === 0) {
                confettiActive = false;
            }
        }

        function updateStats() {
            if (isTeamMode) {
                let playerStatsHTML = '';
                playerRoster.forEach(player => {
                    playerStatsHTML += `${getLastName(player.name)}: ${player.stats.goals} goals<br>`;
                });
                document.getElementById('playerStats').innerHTML = playerStatsHTML;

                let opponentStatsHTML = '';
                opposingRoster.forEach(player => {
                    opponentStatsHTML += `${getLastName(player.name)}: ${player.stats.goals} goals<br>`;
                });
                document.getElementById('opponentStats').innerHTML = opponentStatsHTML;
            }
        }

        function updateSwapIndicator(currentTime) {
            if (isTeamMode) {
                const timeSinceLastSwap = currentTime - lastSwapTime;
                const timeUntilNextSwap = 10000 - (timeSinceLastSwap % 10000);
                const secondsUntilNextSwap = Math.ceil(timeUntilNextSwap / 1000);

                const nextPlayerIndex = (activePlayerIndex + 1) % 3;
                const nextPlayerName = getLastName(playerRoster[nextPlayerIndex].name);
                document.getElementById('playerSwapIndicator').innerHTML = `Next swap: ${nextPlayerName} in ${secondsUntilNextSwap}s`;

                const nextOppPlayerIndex = (activeOppPlayerIndex + 1) % 3;
                const nextOppPlayerName = getLastName(opposingRoster[nextOppPlayerIndex].name);
                document.getElementById('opponentSwapIndicator').innerHTML = `Next swap: ${nextOppPlayerName} in ${secondsUntilNextSwap}s`;
            }
        }

        function gameLoop(currentTime) {
            if (!gameRunning) return;

            const deltaTime = Math.min((currentTime - prevTime) / 1000, 1 / 60);
            prevTime = currentTime;

            leftPaddleY += leftPaddleDY * deltaTime;
            leftPaddleY = Math.max(0, Math.min(canvas.height - paddleHeight, leftPaddleY));

            if (isTwoPlayer) {
                rightPaddleY += rightPaddleDY * deltaTime;
                rightPaddleY = Math.max(0, Math.min(canvas.height - paddleHeight, rightPaddleY));
            } else if (!isPenaltyShot && gameStarted) {
                const offset = (Math.random() - 0.5) * aiOffset;
                const targetY = ballY - paddleHeight / 2 + offset;
                if (rightPaddleY + paddleHeight / 2 < targetY) {
                    rightPaddleY += aiPaddleSpeed * deltaTime;
                } else if (rightPaddleY + paddleHeight / 2 > targetY) {
                    rightPaddleY -= aiPaddleSpeed * deltaTime;
                }
                rightPaddleY = Math.max(0, Math.min(canvas.height - paddleHeight, rightPaddleY));
            } else if (isPenaltyShot) {
                goalY = (canvas.height / 2 - goalHeight / 2) + Math.sin(Date.now() / 1000 * goalFrequency) * goalAmplitude;
                goalY = Math.max(0, Math.min(canvas.height - goalHeight, goalY));
            }

            if (isTeamMode && gameStarted) {
                if (currentTime - lastSwapTime > 10000) {
                    activePlayerIndex = (activePlayerIndex + 1) % 3;
                    activeOppPlayerIndex = (activeOppPlayerIndex + 1) % 3;
                    lastSwapTime = currentTime;
                    document.getElementById('player1IconScore').src = playerRoster[activePlayerIndex].imgSrc;
                    document.getElementById('player1NameScore').textContent = getLastName(playerRoster[activePlayerIndex].name);
                    document.getElementById('player2IconScore').src = opposingRoster[activeOppPlayerIndex].imgSrc;
                    document.getElementById('player2NameScore').textContent = getLastName(opposingRoster[activeOppPlayerIndex].name);
                }
            }

            if (puckDropActive) {
                const elapsed = currentTime - puckDropStartTime;
                if (elapsed < puckDropDuration) {
                    let currentSize, currentY;
                    if (elapsed < 2000) {
                        currentSize = initialPuckSize;
                        currentY = canvas.height / 2 - initialPuckSize / 2;
                    } else {
                        const shrinkProgress = (elapsed - 2000) / 2000;
                        currentSize = initialPuckSize - (initialPuckSize - ballSize) * shrinkProgress;
                        const startY = canvas.height / 2 - initialPuckSize / 2;
                        const endY = canvas.height / 2 - ballSize / 2 + 20;
                        currentY = startY + (endY - startY) * shrinkProgress;
                    }
                    ctx.drawImage(puckImage, canvas.width / 2 - currentSize / 2, currentY, currentSize, currentSize);
                } else {
                    puckDropActive = false;
                    gameStarted = true;
                    ballX = canvas.width / 2;
                    ballY = canvas.height / 2 + 20;
                    const angle = (Math.random() * 120 - 60) * Math.PI / 180;
                    const direction = Math.random() < 0.5 ? -1 : 1;
                    const initialSpeed = 350;
                    ballSpeedX = direction * initialSpeed * Math.cos(angle);
                    ballSpeedY = initialSpeed * Math.sin(angle);
                }
            } else if (gameStarted) {
                ballX += ballSpeedX * deltaTime;
                ballY += ballSpeedY * deltaTime;

                if (ballTrail.length > 5) ballTrail.shift();
                ballTrail.push({ x: ballX, y: ballY });

                if (ballY - ballSize / 2 <= 0 || ballY + ballSize / 2 >= canvas.height) {
                    ballSpeedY *= -1;
                    playSound(300, 0.05);
                }

                if (ballX - ballSize / 2 <= 20 && ballX + ballSize / 2 >= 10 && 
                    ballY + ballSize / 2 >= leftPaddleY && ballY - ballSize / 2 <= leftPaddleY + paddleHeight) {
                    ballSpeedX = Math.abs(ballSpeedX) + 30;
                    ballSpeedX = Math.min(ballSpeedX, maxBallSpeed);
                    const hitPos = (ballY - leftPaddleY) / paddleHeight - 0.5;
                    ballSpeedY = hitPos * 800;
                    playSound(400, 0.05);
                    if (isTeamMode) {
                        playerRoster[activePlayerIndex].stats.paddleHits++;
                    }
                }

                if (!isPenaltyShot && ballX + ballSize / 2 >= canvas.width - 20 && 
                    ballX - ballSize / 2 <= canvas.width - 10 && 
                    ballY + ballSize / 2 >= rightPaddleY && ballY - ballSize / 2 <= rightPaddleY + paddleHeight) {
                    ballSpeedX = - (Math.abs(ballSpeedX) + 30);
                    ballSpeedX = Math.max(ballSpeedX, -maxBallSpeed);
                    const hitPos = (ballY - rightPaddleY) / paddleHeight - 0.5;
                    ballSpeedY = hitPos * 800;
                    playSound(400, 0.05);
                    if (isTeamMode) {
                        opposingRoster[activeOppPlayerIndex].stats.paddleHits++;
                    }
                }

                const notificationText = document.getElementById('notificationText');
                if (ballX - ballSize / 2 <= 0) {
                    if (isPenaltyShot) {
                        misses++;
                        document.getElementById('player2Score').textContent = misses;
                        notificationText.textContent = "MISS!";
                        notificationText.classList.remove('flash', 'flashGoal', 'wildFlashHatTrick', 'wildFlashGoal');
                        notificationText.style.display = 'block';
                        playSadBeepBoop();
                        setTimeout(() => { notificationText.style.display = 'none'; }, 2000);
                        resetBall(currentTime);
                    } else {
                        rightScore++;
                        document.getElementById('player2Score').textContent = rightScore;
                        goalFlashTime = currentTime / 1000;
                        scoreFlashTime = currentTime / 1000;
                        if (isTeamMode) {
                            opposingRoster[activeOppPlayerIndex].stats.goals++;
                            updateStats();
                        }
                        if (!isPenaltyShot && rightScore === 3) {
                            notificationText.textContent = "HAT TRICK!";
                            if (isTeamMode && selectedOpponent === "Minnesota Wild") {
                                notificationText.classList.add('wildFlashHatTrick');
                                createConfetti(['#004C36', '#A6192E', '#FFD700']);
                            } else {
                                notificationText.classList.add('flash');
                            }
                            playHatTrickSound();
                        } else {
                            notificationText.textContent = "GOAL!";
                            if (isTeamMode && selectedOpponent === "Minnesota Wild") {
                                notificationText.classList.add('wildFlashGoal');
                            } else {
                                notificationText.classList.add('flashGoal');
                            }
                        }
                        notificationText.style.display = 'block';
                        playGoalSound();
                        setTimeout(() => {
                            notificationText.style.display = 'none';
                            notificationText.classList.remove('flash', 'flashGoal', 'wildFlashHatTrick', 'wildFlashGoal');
                        }, 2000);
                        if (!isPenaltyShot && rightScore >= winningScore) {
                            gameRunning = false;
                            showVictoryScreen('right');
                        } else {
                            resetBall(currentTime);
                        }
                    }
                } else if (ballX + ballSize / 2 >= canvas.width) {
                    if (isPenaltyShot) {
                        leftScore++;
                        document.getElementById('player1Score').textContent = leftScore;
                        goalFlashTime = currentTime / 1000;
                        scoreFlashTime = currentTime / 1000;
                        notificationText.textContent = "GOAL!";
                        notificationText.classList.add('flashGoal');
                        notificationText.classList.remove('wildFlashHatTrick', 'wildFlashGoal');
                        notificationText.style.display = 'block';
                        playGoalSound();
                        setTimeout(() => {
                            notificationText.style.display = 'none';
                            notificationText.classList.remove('flashGoal');
                        }, 2000);
                        resetBall(currentTime);
                    } else {
                        leftScore++;
                        document.getElementById('player1Score').textContent = leftScore;
                        goalFlashTime = currentTime / 1000;
                        scoreFlashTime = currentTime / 1000;
                        if (isTeamMode) {
                            playerRoster[activePlayerIndex].stats.goals++;
                            updateStats();
                        }
                        if (!isPenaltyShot && leftScore === 3) {
                            notificationText.textContent = "HAT TRICK!";
                            notificationText.classList.add('flash');
                            notificationText.classList.remove('wildFlashHatTrick', 'wildFlashGoal');
                            playHatTrickSound();
                            createConfetti();
                        } else {
                            notificationText.textContent = "GOAL!";
                            notificationText.classList.add('flashGoal');
                            notificationText.classList.remove('wildFlashHatTrick', 'wildFlashGoal');
                        }
                        notificationText.style.display = 'block';
                        playGoalSound();
                        setTimeout(() => {
                            notificationText.style.display = 'none';
                            notificationText.classList.remove('flash', 'flashGoal');
                        }, 2000);
                        if (!isPenaltyShot && leftScore >= winningScore) {
                            gameRunning = false;
                            showVictoryScreen('left');
                        } else {
                            resetBall(currentTime);
                        }
                    }
                }
            }

            ctx.fillStyle = '#E8E8E8';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#FFFFFF';
            ctx.lineWidth = 4;
            ctx.strokeRect(10, 10, canvas.width - 20, canvas.height - 20);

            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 2;
            for (let i = 0; i < 10; i++) {
                ctx.beginPath();
                ctx.moveTo(i * 100 + scratchOffset, 0);
                ctx.lineTo(i * 100 + scratchOffset + 50, canvas.height);
                ctx.stroke();
            }

            ctx.fillStyle = '#800000';
            ctx.fillRect(canvas.width / 2 - 4, 0, 8, canvas.height);

            ctx.fillStyle = '#4682B4';
            ctx.fillRect(canvas.width / 3 - 4, 0, 8, canvas.height);
            ctx.fillRect(2 * canvas.width / 3 - 4, 0, 8, canvas.height);

            if (centerIceLogo.complete) {
                ctx.drawImage(centerIceLogo, canvas.width / 2 - 100, canvas.height / 2 - 100, 200, 200);
            }

            ctx.fillStyle = '#800000';
            ctx.fillRect(canvas.width / 3 + 45, canvas.height / 4 - 5, 10, 10);
            ctx.fillRect(canvas.width / 3 + 45, 3 * canvas.height / 4 - 5, 10, 10);
            ctx.fillRect(2 * canvas.width / 3 - 55, canvas.height / 4 - 5, 10, 10);
            ctx.fillRect(2 * canvas.width / 3 - 55, 3 * canvas.height / 4 - 5, 10, 10);

            ctx.fillRect(canvas.width / 2 - 10, canvas.height / 4 - 5, 20, 10);
            ctx.fillRect(canvas.width / 2 - 10, 3 * canvas.height / 4 - 5, 20, 10);
            ctx.fillRect(canvas.width / 3 + 30, canvas.height / 4 - 5, 20, 10);
            ctx.fillRect(canvas.width / 3 + 30, 3 * canvas.height / 4 - 5, 20, 10);
            ctx.fillRect(2 * canvas.width / 3 - 50, canvas.height / 4 - 5, 20, 10);
            ctx.fillRect(2 * canvas.width / 3 - 50, 3 * canvas.height / 4 - 5, 20, 10);

            drawFaceOffCircles();

            if (puckDropActive) {
                const elapsed = currentTime - puckDropStartTime;
                if (elapsed < puckDropDuration) {
                    let currentSize, currentY;
                    if (elapsed < 2000) {
                        currentSize = initialPuckSize;
                        currentY = canvas.height / 2 - initialPuckSize / 2;
                    } else {
                        const shrinkProgress = (elapsed - 2000) / 2000;
                        currentSize = initialPuckSize - (initialPuckSize - ballSize) * shrinkProgress;
                        const startY = canvas.height / 2 - initialPuckSize / 2;
                        const endY = canvas.height / 2 - ballSize / 2 + 20;
                        currentY = startY + (endY - startY) * shrinkProgress;
                    }
                    ctx.drawImage(puckImage, canvas.width / 2 - currentSize / 2, currentY, currentSize, currentSize);
                }
            } else if (gameStarted) {
                for (let i = 0; i < ballTrail.length; i++) {
                    const alpha = (i + 1) / ballTrail.length * 0.3;
                    ctx.globalAlpha = alpha;
                    ctx.drawImage(puckImage, ballTrail[i].x - ballSize / 2, ballTrail[i].y - ballSize / 2, ballSize, ballSize);
                    ctx.globalAlpha = 1;
                }
                ctx.drawImage(puckImage, ballX - ballSize / 2, ballY - ballSize / 2, ballSize, ballSize);
            }

            ctx.fillStyle = "#8B0000";
            ctx.fillRect(10, leftPaddleY, paddleWidth, paddleHeight);
            if (!isPenaltyShot) {
                if (selectedOpponent === "Minnesota Wild") {
                    ctx.fillStyle = "#004C36"; // Green
                    ctx.fillRect(canvas.width - 20, rightPaddleY, 5, paddleHeight);
                    ctx.fillStyle = "#A6192E"; // Red
                    ctx.fillRect(canvas.width - 15, rightPaddleY, 5, paddleHeight);
                } else {
                    ctx.fillStyle = "#8B0000";
                    ctx.fillRect(canvas.width - 20, rightPaddleY, paddleWidth, paddleHeight);
                }
            } else {
                ctx.fillStyle = "#FF0000";
                ctx.fillRect(canvas.width - 20, goalY, paddleWidth, goalHeight);
            }

            if (confettiActive) {
                drawConfetti();
            }

            if (isTeamMode) {
                updateSwapIndicator(currentTime);
            }

            requestAnimationFrame(gameLoop);
        }

        function createSnowflakes() {
            const snowflakesContainer = document.getElementById('snowflakes');
            snowflakesContainer.innerHTML = '';
            const numberOfSnowflakes = 50;
            for (let i = 0; i < numberOfSnowflakes; i++) {
                const snowflake = document.createElement('div');
                snowflake.className = 'snowflake';
                snowflake.style.left = `${Math.random() * 100}vw`;
                snowflake.style.animationDuration = `${Math.random() * 3 + 2}s`;
                snowflake.style.animationDelay = `-${Math.random() * 5}s`;
                snowflake.style.opacity = Math.random();
                snowflake.style.width = `${Math.random() * 5 + 2}px`;
                snowflake.style.height = snowflake.style.width;
                snowflake.style.setProperty('--sway', `${Math.random() * 20 - 10}vw`);
                snowflakesContainer.appendChild(snowflake);
            }
        }

        createSnowflakes();
        playMainMenuMusic();
    </script>
</body>
</html>
