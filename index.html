<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utah Pond Pong</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            background: url('https://github.com/Grretta70/UtahPong/blob/main/Utah%20Hockey%20Pong.png?raw=true') no-repeat center center fixed;
            background-size: cover;
            background-color: #000000;
            color: white;
            text-align: center;
            font-family: 'Press Start 2P', sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        body:not(.main-menu) {
            background: #000000;
        }
        #mainMenu, #playerCountMenu, #difficultySelect, #gameModeSelect, #characterSelect, #preGameScreen, #gameContainer, #victoryScreen, #creditsModal {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        #playerCountMenu, #difficultySelect, #gameModeSelect, #characterSelect, #preGameScreen, #gameContainer, #victoryScreen, #creditsModal {
            display: none;
            backdrop-filter: blur(5px);
        }
        #mainMenu {
            padding: 40px;
            border-radius: 10px;
            max-width: 1080px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }
        #creditsButton {
            padding: 8px 12px;
            font-size: 12px;
            min-width: 100px;
            margin: 10px;
        }
        #creditsModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #creditsImage {
            max-width: 80%;
            max-height: 80%;
            border: 4px solid #6CAEDF;
            border-radius: 10px;
        }
        #closeCreditsButton {
            margin-top: 20px;
            padding: 8px 12px;
            font-size: 12px;
            min-width: 100px;
        }
        #gameModeSelect .mode-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        #characterSelect .character-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            width: 600px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }
        #characterSelect .top-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        #characterSelect .bottom-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        .character-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 14px;
            background: #000000;
            border: 4px solid #6CAEDF;
            border-radius: 0;
            transition: transform 0.2s;
            cursor: pointer;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }
        .character-option:hover {
            transform: scale(1.05);
        }
        .character-option.locked {
            background: #000000;
            border: 4px solid #6CAEDF;
            cursor: not-allowed;
            transform: none;
            opacity: 0.6;
            box-shadow: none;
        }
        .character-option.locked:hover {
            transform: none;
        }
        .character-option img {
            width: 120px;
            height: 120px;
            border: 2px solid transparent;
            filter: drop-shadow(2px 2px 2px rgba(0, 0, 0, 0.5));
        }
        .character-option span {
            margin-top: 10px;
            font-size: 16px;
            color: white;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 0;
            text-align: center;
            width: 100%;
            box-sizing: border-box;
        }
        .character-option.selected {
            border: 8px solid #FFFFFF;
        }
        .character-option.selected img {
            border: 4px solid #FFFFFF;
        }
        #preGameScreen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            padding: 40px;
            border-radius: 10px;
            gap: 30px;
        }
        #preGameScreen .player-info-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
        }
        #preGameScreen .player-info {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #preGameScreen .player-info img {
            width: 120px;
            height: 120px;
        }
        #preGameScreen .vs-text {
            font-size: 36px;
            color: #6CAEDF;
            text-shadow: 4px 4px 0 #000000;
            margin: 0 30px;
        }
        #gameContainer {
            flex-direction: column;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            max-height: 100vh;
            overflow: hidden;
        }
        #victoryScreen {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #victoryScreen img {
            width: 200px;
            height: 200px;
            margin: 10px 0;
            animation: winnerFlash 1s infinite;
        }
        @keyframes winnerFlash {
            0%, 100% { border: 4px solid #FFFFFF; }
            50% { border: 4px solid #6CAEDF; }
        }
        #victoryCanvas {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            z-index: 0;
            width: 800px;
            height: 400px;
        }
        #victoryScreen h2 {
            margin: 50px 0 10px 0;
            z-index: 1;
            font-size: 24px;
        }
        #victoryScreen img, #victoryScreen button {
            position: relative;
            z-index: 1;
        }
        button {
            margin: 10px;
            padding: 12px 18px;
            font-size: 14px;
            cursor: pointer;
            background-color: #000000;
            color: #FFFFFF;
            border: 4px solid #6CAEDF;
            border-radius: 0;
            font-family: 'Press Start 2P', sans-serif;
            min-width: 150px;
            text-shadow: 2px 2px 0 #000000;
            transition: transform 0.2s;
        }
        button:hover {
            transform: scale(1.05);
        }
        button.selected {
            /* box-shadow: 0 0 10px #6CAEDF, 0 0 20px #6CAEDF; */
        }
        #player1Icon, #player2Icon {
            width: 100px;
            height: 100px;
        }
        canvas {
            margin: 0 20px;
            background: rgba(0, 0, 0, 0.5);
            border: 4px solid #6CAEDF;
            padding: 5px;
        }
        #player1Name, #player2Name {
            font-size: 20px;
            color: #6CAEDF;
            margin: 10px 0;
        }
        #player1Name {
            text-align: left;
            width: 800px;
        }
        #player2Name {
            text-align: right;
            width: 800px;
        }
        .paddle-hit {
            animation: paddleFlash 0.2s;
        }
        @keyframes paddleFlash {
            0% { border: 4px solid #FFFFFF; }
            100% { border: none; }
        }
    </style>
</head>
<body class="main-menu">
    <audio id="mainMenuMusic" loop>
        <source src="https://raw.githubusercontent.com/Grretta70/UtahPong/main/Ice%20Breakers.mp3" type="audio/mpeg">
    </audio>
    <audio id="gameMusic" loop>
        <source src="https://raw.githubusercontent.com/Grretta70/UtahPong/main/Ice%20Rink%20Rebels.mp3" type="audio/mpeg">
    </audio>
    <audio id="victoryMusic">
        <source src="https://raw.githubusercontent.com/Grretta70/UtahPong/main/Pixelated%20Triumph.mp3" type="audio/mpeg">
    </audio>
    
    <div id="mainMenu">
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); showPlayerCountMenu()">Play</button>
        <button id="creditsButton" onclick="playSound(500, 0.1, 0.1); toggleSelected(this); showCredits()">Credits</button>
    </div>
    
    <div id="creditsModal">
        <img id="creditsImage" src="https://github.com/Grretta70/UtahPong/blob/main/1.png?raw=true" alt="Credits">
        <button id="closeCreditsButton" onclick="playSound(500, 0.1, 0.1); toggleSelected(this); hideCredits()">Close</button>
    </div>
    
    <div id="playerCountMenu">
        <h2>Start Game</h2>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); showDifficultySelect()">1 Player</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); showGameModeSelect2Player()">2 Players</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); goBackToMainMenuFromPlayerCount()">Back</button>
    </div>
    
    <div id="difficultySelect">
        <h2>Select Difficulty</h2>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); setDifficulty('rookie'); showGameModeSelect()">Rookie</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); setDifficulty('ahl'); showGameModeSelect()">AHL</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); setDifficulty('nhl'); showGameModeSelect()">NHL</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); goBackToPlayerCount()">Back</button>
    </div>
    
    <div id="gameModeSelect">
        <h2 id="gameModeTitle">Game Mode</h2>
        <div class="mode-grid" id="modeGrid"></div>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); goBackToPlayerCount()">Back</button>
    </div>
    
    <div id="characterSelect">
        <h2 id="characterSelectTitle"></h2>
        <div class="character-container">
            <div class="top-row">
                <div class="character-option" onclick="selectCharacter('Clayton Keller', this.querySelector('img'))">
                    <img src="https://github.com/Grretta70/UtahPong/blob/main/ClaytonKeller_processed.png?raw=true">
                    <span>Clayton Keller</span>
                </div>
                <div class="character-option" onclick="selectCharacter('Logan Cooley', this.querySelector('img'))">
                    <img src="https://github.com/Grretta70/UtahPong/blob/main/LoganCooley_processed.png?raw=true">
                    <span>Logan Cooley</span>
                </div>
            </div>
            <div class="bottom-row">
                <div class="character-option" onclick="selectCharacter('Dylan Guenther', this.querySelector('img'))">
                    <img src="https://github.com/Grretta70/UtahPong/blob/main/DylanGuenther_processed.png?raw=true">
                    <span>Dylan Guenther</span>
                </div>
                <div class="character-option" onclick="selectCharacter('Michael Kesselring', this.querySelector('img'))">
                    <img src="https://github.com/Grretta70/UtahPong/blob/main/MichaelKesselring_processed.png?raw=true">
                    <span>Michael Kesselring</span>
                </div>
                <div class="character-option" onclick="selectCharacter('Liam O\'Brien', this.querySelector('img'))">
                    <img src="https://github.com/Grretta70/UtahPong/blob/main/LiamObrein_processed.png?raw=true">
                    <span>Liam O'Brien</span>
                </div>
            </div>
        </div>
        <div id="characterButtonContainer">
            <button id="backButton" onclick="playSound(500, 0.1, 0.1); toggleSelected(this); goBackToGameModeSelect()">Back</button>
            <button id="confirmButton" onclick="playSound(500, 0.1, 0.1); toggleSelected(this); confirmCharacterSelection()" style="display: none;">Confirm</button>
        </div>
    </div>
    
    <div id="preGameScreen">
        <div class="player-info-container">
            <div class="player-info">
                <img id="player1PreGameIcon" src="" alt="Player 1 Icon">
                <span id="player1PreGameName"></span>
            </div>
            <span class="vs-text">VS</span>
            <div class="player-info">
                <img id="player2PreGameIcon" src="" alt="Player 2 Icon">
                <span id="player2PreGameName"></span>
            </div>
        </div>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); startGame()">Begin</button>
    </div>
    
    <div id="gameContainer">
        <div id="player1Name"></div>
        <div style="display: flex; align-items: center;">
            <div id="player1Icon"></div>
            <canvas id="gameCanvas" width="800" height="400"></canvas>
            <div id="player2Icon"></div>
        </div>
        <div id="player2Name"></div>
    </div>
    
    <div id="victoryScreen">
        <canvas id="victoryCanvas" width="800" height="400"></canvas>
        <h2 id="victoryMessage"></h2>
        <img id="victoryIcon" src="" alt="Winner Icon">
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); returnToGameModeSelect()">Back to Game Modes</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); returnToMainMenu()">Back to Main Menu</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); replayGame()">Replay</button>
        <button onclick="playSound(500, 0.1, 0.1); toggleSelected(this); exitGame()">Exit</button>
    </div>
    
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const victoryCanvas = document.getElementById('victoryCanvas');
        const victoryCtx = victoryCanvas.getContext('2d');
        
        let leftPaddleY = 150;
        let rightPaddleY = 150;
        let ballX = canvas.width / 2;
        let ballY = canvas.height / 2;
        let ballSpeedX = 0;
        let ballSpeedY = 0;
        let paddleHeight = 70;
        let paddleWidth = 10;
        let leftScore = 0;
        let rightScore = 0;
        let gameRunning = false;
        let gameStarted = false;
        let leftPaddleDY = 0;
        let rightPaddleDY = 0;
        let aiPaddleSpeed = 300;
        let aiOffset = 50;
        let isTwoPlayer = false;
        let isPenaltyShot = false;
        let goalY = 150;
        let goalHeight = 100;
        let goalSpeed = 200;
        let goalAmplitude = 100;
        let goalFrequency = 1;
        let misses = 0;
        
        const paddleSpeed = 360;
        let maxBallSpeed = 600;
        
        let player1Character = null;
        let player2Character = null;
        let selectionState = 'player1';
        let winningScore = 0;
        let speedIncreaseInterval = null;
        let prevTime = performance.now();
        let player1Confirmed = false;
        let player2Confirmed = false;
        
        let goalFlashTime = 0;
        const goalFlashDuration = 1;
        let hatTrickFlashTime = 0;
        const hatTrickFlashDuration = 3;
        
        const mainMenuMusic = document.getElementById('mainMenuMusic');
        const gameMusic = document.getElementById('gameMusic');
        const victoryMusic = document.getElementById('victoryMusic');
        mainMenuMusic.volume = 0.3;
        gameMusic.volume = 0.3;
        victoryMusic.volume = 0.3;

        const characters = [
            { name: "Clayton Keller", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/ClaytonKeller_processed.png?raw=true", locked: false },
            { name: "Logan Cooley", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/LoganCooley_processed.png?raw=true", locked: false },
            { name: "Dylan Guenther", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/DylanGuenther_processed.png?raw=true", locked: false },
            { name: "Michael Kesselring", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/MichaelKesselring_processed.png?raw=true", locked: false },
            { name: "Liam O'Brien", imgSrc: "https://github.com/Grretta70/UtahPong/blob/main/LiamObrein_processed.png?raw=true", locked: false }
        ];

        const goalieImage = new Image();
        goalieImage.src = "https://via.placeholder.com/20x100.png?text=Goalie";

        let particles = [];
        let confettiRunning = false;
        const confettiColors = ['#6CAEDF', '#FFFFFF'];

        function createConfetti() {
            particles = [];
            for (let i = 0; i < 100; i++) {
                particles.push({
                    x: Math.random() * victoryCanvas.width,
                    y: Math.random() * -victoryCanvas.height,
                    width: 6 + Math.random() * 4,
                    height: 6 + Math.random() * 4,
                    color: confettiColors[Math.floor(Math.random() * confettiColors.length)],
                    speedY: 50 + Math.random() * 100,
                    speedX: (Math.random() - 0.5) * 50
                });
            }
            confettiRunning = true;
            animateConfetti();
        }

        function animateConfetti() {
            if (!confettiRunning) return;

            victoryCtx.clearRect(0, 0, victoryCanvas.width, victoryCanvas.height);

            particles.forEach(particle => {
                particle.y += particle.speedY * (1/60);
                particle.x += particle.speedX * (1/60);

                if (particle.y > victoryCanvas.height) {
                    particle.y = -particle.height;
                    particle.x = Math.random() * victoryCanvas.width;
                }

                victoryCtx.fillStyle = particle.color;
                victoryCtx.fillRect(particle.x, particle.y, particle.width, particle.height);
            });

            requestAnimationFrame(animateConfetti);
        }

        function stopConfetti() {
            confettiRunning = false;
            victoryCtx.clearRect(0, 0, victoryCanvas.width, victoryCanvas.height);
            particles = [];
        }

        let hitParticles = [];

        function createHitParticles(x, y, paddleSide) {
            const numParticles = 5;
            for (let i = 0; i < numParticles; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = 50 + Math.random() * 50;
                hitParticles.push({
                    x: x,
                    y: y,
                    speedX: Math.cos(angle) * speed * (paddleSide === 'left' ? 1 : -1),
                    speedY: Math.sin(angle) * speed,
                    size: 4 + Math.random() * 2,
                    life: 0.5,
                    maxLife: 0.5
                });
            }
        }

        function updateHitParticles(deltaTime) {
            hitParticles = hitParticles.filter(particle => particle.life > 0);
            hitParticles.forEach(particle => {
                particle.x += particle.speedX * deltaTime;
                particle.y += particle.speedY * deltaTime;
                particle.life -= deltaTime;
                particle.size *= 0.95;
            });
        }

        function drawHitParticles() {
            hitParticles.forEach(particle => {
                const alpha = particle.life / particle.maxLife;
                ctx.fillStyle = `rgba(255, 255, 255, ${alpha})`;
                ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
            });
        }

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        function playSound(frequency, duration, volume = 0.3) {
            try {
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                gainNode.gain.setValueAtTime(volume, audioCtx.currentTime);
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                oscillator.start();
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (error) {
                console.error('Error in playSound:', error);
            }
        }

        function toggleSelected(button) {
            try {
                const parent = button.parentElement;
                const buttons = parent.querySelectorAll('button');
                buttons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
            } catch (error) {
                console.error('Error in toggleSelected:', error);
            }
        }

        function clearButtonGlow() {
            try {
                document.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
            } catch (error) {
                console.error('Error in clearButtonGlow:', error);
            }
        }

        function playMainMenuMusic() {
            gameMusic.pause();
            victoryMusic.pause();
            if (mainMenuMusic.paused) {
                mainMenuMusic.play().catch(error => {
                    console.log("Autoplay prevented:", error);
                    document.addEventListener('click', () => {
                        mainMenuMusic.play();
                    }, { once: true });
                });
            }
        }

        function playGameMusic() {
            mainMenuMusic.pause();
            victoryMusic.pause();
            if (gameMusic.paused) {
                gameMusic.play();
            }
        }

        function playVictoryMusic() {
            mainMenuMusic.pause();
            gameMusic.pause();
            if (victoryMusic.paused) {
                victoryMusic.currentTime = 0;
                victoryMusic.play().catch(error => {
                    console.log("Autoplay prevented for victory music:", error);
                    document.addEventListener('click', () => {
                        victoryMusic.play();
                    }, { once: true });
                });
            }
        }

        function showCredits() {
            document.getElementById('creditsModal').style.display = 'flex';
            clearButtonGlow();
        }

        function hideCredits() {
            document.getElementById('creditsModal').style.display = 'none';
            clearButtonGlow();
        }

        document.getElementById('creditsModal')?.addEventListener('click', function(event) {
            if (event.target.id === 'creditsModal') {
                playSound(500, 0.1, 0.1);
                hideCredits();
            }
        });

        function showPlayerCountMenu() {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('playerCountMenu').style.display = 'flex';
            document.body.classList.remove('main-menu');
            clearButtonGlow();
            playMainMenuMusic();
        }

        function goBackToMainMenuFromPlayerCount() {
            document.getElementById('playerCountMenu').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            document.body.classList.add('main-menu');
            clearButtonGlow();
            playMainMenuMusic();
        }

        function showDifficultySelect() {
            document.getElementById('playerCountMenu').style.display = 'none';
            document.getElementById('difficultySelect').style.display = 'flex';
            clearButtonGlow();
            playMainMenuMusic();
        }

        function setDifficulty(level) {
            switch (level) {
                case 'rookie':
                    aiPaddleSpeed = 200;
                    aiOffset = 50;
                    maxBallSpeed = 600;
                    goalSpeed = 150;
                    goalAmplitude = 50;
                    goalFrequency = 0.5;
                    break;
                case 'ahl':
                    aiPaddleSpeed = 350;
                    aiOffset = 40;
                    maxBallSpeed = 650;
                    goalSpeed = 200;
                    goalAmplitude = 75;
                    goalFrequency = 1;
                    break;
                case 'nhl':
                    aiPaddleSpeed = 650;
                    aiOffset = 20;
                    maxBallSpeed = 750;
                    goalSpeed = 300;
                    goalAmplitude = 100;
                    goalFrequency = 1.5;
                    break;
            }
        }

        function showGameModeSelect() {
            document.getElementById('difficultySelect').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            document.getElementById('gameModeTitle').textContent = '1 PLAYER MODES';
            const modeGrid = document.getElementById('modeGrid');
            modeGrid.innerHTML = '';
            const points = ['Shootout', '3 Points', '5 Points', '10 Points', 'Penalty Shot'];
            points.forEach(point => {
                const btn = document.createElement('button');
                btn.textContent = point;
                btn.onclick = () => { 
                    playSound(500, 0.1, 0.1); 
                    toggleSelected(btn); 
                    isTwoPlayer = false; 
                    isPenaltyShot = (point === 'Penalty Shot');
                    startCharacterSelect(point === 'Shootout' || point === 'Penalty Shot' ? 1 : parseInt(point));
                };
                modeGrid.appendChild(btn);
            });
            clearButtonGlow();
            playMainMenuMusic();
        }

        function showGameModeSelect2Player() {
            document.getElementById('playerCountMenu').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            document.getElementById('gameModeTitle').textContent = '2 PLAYER MODES';
            const modeGrid = document.getElementById('modeGrid');
            modeGrid.innerHTML = '';
            const points = ['Shootout', '3 Points', '5 Points', '10 Points'];
            points.forEach(point => {
                const btn = document.createElement('button');
                btn.textContent = point;
                btn.onclick = () => { 
                    playSound(500, 0.1, 0.1); 
                    toggleSelected(btn); 
                    isTwoPlayer = true; 
                    startCharacterSelect(point === 'Shootout' ? 1 : parseInt(point));
                };
                modeGrid.appendChild(btn);
            });
            clearButtonGlow();
            playMainMenuMusic();
        }

        function goBackToPlayerCount() {
            document.getElementById('gameModeSelect').style.display = 'none';
            document.getElementById('playerCountMenu').style.display = 'flex';
            clearButtonGlow();
            playMainMenuMusic();
        }

        function startCharacterSelect(points) {
            winningScore = points;
            document.getElementById('gameModeSelect').style.display = 'none';
            document.getElementById('characterSelect').style.display = 'flex';
            selectionState = 'player1';
            player1Character = null;
            player2Character = null;
            player1Confirmed = false;
            player2Confirmed = false;
            document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 1';
            characters.forEach(character => character.locked = false);
            document.querySelectorAll('.character-option').forEach(option => {
                option.classList.remove('selected');
                option.classList.remove('locked');
            });
            document.getElementById('confirmButton').style.display = 'none';
            clearButtonGlow();
            playMainMenuMusic();
        }

        function goBackToGameModeSelect() {
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            if (isTwoPlayer) {
                showGameModeSelect2Player();
            } else {
                showGameModeSelect();
            }
            clearButtonGlow();
            playMainMenuMusic();
            stopConfetti();
        }

        function returnToGameModeSelect() {
            document.getElementById('victoryScreen').style.display = 'none';
            document.getElementById('gameModeSelect').style.display = 'flex';
            if (isTwoPlayer) {
                showGameModeSelect2Player();
            } else {
                showGameModeSelect();
            }
            clearButtonGlow();
            playMainMenuMusic();
            stopConfetti();
        }

        function returnToMainMenu() {
            document.getElementById('victoryScreen').style.display = 'none';
            document.getElementById('mainMenu').style.display = 'flex';
            document.body.classList.add('main-menu');
            clearButtonGlow();
            playMainMenuMusic();
            stopConfetti();
        }

        function replayGame() {
            document.getElementById('victoryScreen').style.display = 'none';
            startGame();
            stopConfetti();
        }

        function exitGame() {
            window.close();
            stopConfetti();
        }

        document.addEventListener("keydown", function(event) {
            if (!gameStarted && gameRunning && (event.key === "w" || event.key === "s" || event.key === "ArrowUp" || event.key === "ArrowDown")) {
                gameStarted = true;
                ballSpeedX = (Math.random() > 0.5 ? 1 : -1) * 420;
                ballSpeedY = (Math.random() > 0.5 ? 1 : -1) * 420;
            }
            if (event.key === "w") leftPaddleDY = -paddleSpeed;
            if (event.key === "s") leftPaddleDY = paddleSpeed;
            if (isTwoPlayer) {
                if (event.key === "ArrowUp") rightPaddleDY = -paddleSpeed;
                if (event.key === "ArrowDown") rightPaddleDY = paddleSpeed;
            }
        });

        document.addEventListener("keyup", function(event) {
            if (event.key === "w" || event.key === "s") leftPaddleDY = 0;
            if (isTwoPlayer && (event.key === "ArrowUp" || event.key === "ArrowDown")) rightPaddleDY = 0;
        });

        function selectCharacter(character, element) {
            const selectedCharacter = characters.find(c => c.name === character);
            if (selectedCharacter.locked) {
                return;
            }

            const isAlreadySelected = (selectionState === 'player1' && player1Character && player1Character.name === character) ||
                                      (selectionState === 'player2' && player2Character && player2Character.name === character);

            document.querySelectorAll('.character-option').forEach(option => {
                option.classList.remove('selected');
            });

            if (isAlreadySelected) {
                if (selectionState === 'player1') {
                    player1Character = null;
                    document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 1';
                    document.getElementById('confirmButton').style.display = 'none';
                } else if (selectionState === 'player2') {
                    player2Character = null;
                    document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 2';
                    document.getElementById('confirmButton').style.display = 'none';
                }
                playSound(600, 0.1, 0.1);
            } else {
                element.parentElement.classList.add('selected');
                playSound(600, 0.1, 0.1);

                if (selectionState === 'player1') {
                    player1Character = { name: character, imgSrc: element.src };
                    document.getElementById('characterSelectTitle').textContent = 'PLAYER 1: CONFIRM YOUR CHOICE';
                    document.getElementById('confirmButton').style.display = 'inline-block';
                } else if (selectionState === 'player2') {
                    player2Character = { name: character, imgSrc: element.src };
                    document.getElementById('characterSelectTitle').textContent = 'PLAYER 2: CONFIRM YOUR CHOICE';
                    document.getElementById('confirmButton').style.display = 'inline-block';
                }
            }
        }

        function confirmCharacterSelection() {
            if (selectionState === 'player1' && player1Character) {
                player1Confirmed = true;
                characters.find(c => c.name === player1Character.name).locked = true;
                document.querySelectorAll('.character-option').forEach(option => {
                    const optionName = option.querySelector('span').textContent;
                    if (optionName === player1Character.name) {
                        option.classList.add('locked');
                    }
                });
                if (isTwoPlayer) {
                    selectionState = 'player2';
                    document.getElementById('characterSelectTitle').textContent = 'SELECT PLAYER 2';
                    document.getElementById('confirmButton').style.display = 'none';
                    document.querySelectorAll('.character-option').forEach(option => {
                        option.classList.remove('selected');
                        const optionName = option.querySelector('span').textContent;
                        const char = characters.find(c => c.name === optionName);
                        if (!char.locked) {
                            option.classList.remove('locked');
                        }
                    });
                } else {
                    const availableCharacters = characters.filter(c => c.imgSrc !== player1Character.imgSrc);
                    player2Character = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
                    showPreGameScreen();
                }
            } else if (selectionState === 'player2' && player2Character) {
                player2Confirmed = true;
                characters.find(c => c.name === player2Character.name).locked = true;
                document.querySelectorAll('.character-option').forEach(option => {
                    const optionName = option.querySelector('span').textContent;
                    if (optionName === player2Character.name) {
                        option.classList.add('locked');
                    }
                });
                showPreGameScreen();
            }
        }

        function showPreGameScreen() {
            document.getElementById('player1PreGameIcon').src = player1Character.imgSrc;
            document.getElementById('player1PreGameName').textContent = player1Character.name;
            document.getElementById('player2PreGameIcon').src = player2Character.imgSrc;
            document.getElementById('player2PreGameName').textContent = isPenaltyShot ? "Goalie" : player2Character.name;
            document.getElementById('characterSelect').style.display = 'none';
            document.getElementById('preGameScreen').style.display = 'flex';
            clearButtonGlow();
            playMainMenuMusic();
        }

        function startGame() {
            document.getElementById('preGameScreen').style.display = 'none';
            leftScore = 0;
            rightScore = 0;
            misses = 0;
            document.getElementById('gameContainer').style.display = 'flex';
            document.getElementById('player1Icon').innerHTML = '';
            document.getElementById('player2Icon').innerHTML = '';
            const p1Img = document.createElement('img');
            p1Img.src = player1Character.imgSrc;
            p1Img.style.width = '100px';
            p1Img.style.height = '100px';
            document.getElementById('player1Icon').appendChild(p1Img);
            const p2Img = document.createElement('img');
            p2Img.src = player2Character.imgSrc;
            p2Img.style.width = '100px';
            p2Img.style.height = '100px';
            document.getElementById('player2Icon').appendChild(p2Img);
            document.getElementById('player1Name').textContent = player1Character.name;
            document.getElementById('player2Name').textContent = isPenaltyShot ? "Goalie" : player2Character.name;
            gameRunning = true;
            gameStarted = false;
            hitParticles = [];
            goalFlashTime = 0;
            hatTrickFlashTime = 0;
            resetBall();
            if (!isPenaltyShot) {
                speedIncreaseInterval = setInterval(() => {
                    if (gameStarted) {
                        ballSpeedX = Math.min(Math.abs(ballSpeedX) + 10, maxBallSpeed) * Math.sign(ballSpeedX);
                        ballSpeedY = Math.min(Math.abs(ballSpeedY) + 10, maxBallSpeed) * Math.sign(ballSpeedY);
                    }
                }, 5000);
            }
            clearButtonGlow();
            playGameMusic();
            gameLoop();
        }

        function resetBall() {
            ballX = canvas.width / 2;
            ballY = canvas.height / 2;
            ballSpeedX = 0;
            ballSpeedY = 0;
            hitParticles = [];
        }

        function animateVictoryText() {
            const victoryMessage = document.getElementById('victoryMessage');
            function flash() {
                if (document.getElementById('victoryScreen').style.display === 'flex') {
                    victoryMessage.style.color = (Math.sin(Date.now() / 100) > 0) ? '#6CAEDF' : '#FFFFFF';
                    requestAnimationFrame(flash);
                }
            }
            requestAnimationFrame(flash);
        }

        function gameLoop() {
            if (!gameRunning) {
                clearInterval(speedIncreaseInterval);
                return;
            }

            const currentTime = performance.now();
            const deltaTime = (currentTime - prevTime) / 1000;
            prevTime = currentTime;

            leftPaddleY += leftPaddleDY * deltaTime;
            leftPaddleY = Math.max(0, Math.min(canvas.height - paddleHeight, leftPaddleY));

            if (isTwoPlayer) {
                rightPaddleY += rightPaddleDY * deltaTime;
                rightPaddleY = Math.max(0, Math.min(canvas.height - paddleHeight, rightPaddleY));
            } else if (!isPenaltyShot && gameStarted) {
                const offset = (Math.random() - 0.5) * aiOffset;
                const targetY = ballY - paddleHeight / 2 + offset;
                if (rightPaddleY + paddleHeight / 2 < targetY) {
                    rightPaddleY += aiPaddleSpeed * deltaTime;
                } else if (rightPaddleY + paddleHeight / 2 > targetY) {
                    rightPaddleY -= aiPaddleSpeed * deltaTime;
                }
                rightPaddleY = Math.max(0, Math.min(canvas.height - paddleHeight, rightPaddleY));
            } else if (isPenaltyShot) {
                goalY = (canvas.height / 2 - goalHeight / 2) + Math.sin(Date.now() / 1000 * goalFrequency) * goalAmplitude;
                goalY = Math.max(0, Math.min(canvas.height - goalHeight, goalY));
            }

            if (gameStarted) {
                ballX += ballSpeedX * deltaTime;
                ballY += ballSpeedY * deltaTime;

                if (ballY <= 0 || ballY >= canvas.height - 10) {
                    ballSpeedY *= -1;
                    playSound(200, 0.1, 0.1);
                }

                if (ballX <= 20 && ballX >= 10 && ballY + 10 >= leftPaddleY && ballY <= leftPaddleY + paddleHeight) {
                    ballSpeedX = Math.abs(ballSpeedX) + 20;
                    ballSpeedX = Math.min(ballSpeedX, maxBallSpeed);
                    const hitPos = (ballY - leftPaddleY) / paddleHeight - 0.5;
                    ballSpeedY = hitPos * 800;
                    playSound(400, 0.1, 0.1);
                    createHitParticles(20, ballY, 'left');
                }

                if (!isPenaltyShot && ballX >= canvas.width - 30 && ballX <= canvas.width - 20 && ballY + 10 >= rightPaddleY && ballY <= rightPaddleY + paddleHeight) {
                    ballSpeedX = -(Math.abs(ballSpeedX) + 20);
                    ballSpeedX = Math.max(ballSpeedX, -maxBallSpeed);
                    const hitPos = (ballY - rightPaddleY) / paddleHeight - 0.5;
                    ballSpeedY = hitPos * 800;
                    playSound(400, 0.1, 0.1);
                    createHitParticles(canvas.width - 20, ballY, 'right');
                }

                if (isPenaltyShot && ballX >= canvas.width - 20 && ballY + 10 >= goalY && ballY <= goalY + goalHeight) {
                    leftScore++;
                    playSound(600, 0.2, 0.1);
                    resetBall();
                    gameStarted = false;
                    goalFlashTime = goalFlashDuration;
                } else if (ballX + 10 < 0) {
                    if (!isPenaltyShot) {
                        const prevRightScore = rightScore;
                        rightScore++;
                        playSound(100, 0.2, 0.1);
                        if ((winningScore === 5 || winningScore === 10) && prevRightScore === 2 && rightScore === 3) {
                            hatTrickFlashTime = hatTrickFlashDuration;
                        } else {
                            goalFlashTime = goalFlashDuration;
                        }
                    }
                    resetBall();
                    gameStarted = false;
                    hitParticles = [];
                } else if (ballX > canvas.width) {
                    if (isPenaltyShot) {
                        misses++;
                        playSound(100, 0.2, 0.1);
                    } else {
                        const prevLeftScore = leftScore;
                        leftScore++;
                        playSound(100, 0.2, 0.1);
                        if ((winningScore === 5 || winningScore === 10) && prevLeftScore === 2 && leftScore === 3) {
                            hatTrickFlashTime = hatTrickFlashDuration;
                        } else {
                            goalFlashTime = goalFlashDuration;
                        }
                    }
                    resetBall();
                    gameStarted = false;
                    hitParticles = [];
                }
            }

            updateHitParticles(deltaTime);

            if (goalFlashTime > 0) goalFlashTime -= deltaTime;
            if (hatTrickFlashTime > 0) hatTrickFlashTime -= deltaTime;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(10, leftPaddleY, paddleWidth, paddleHeight);
            if (ballX <= 20 && ballX >= 10 && ballY + 10 >= leftPaddleY && ballY <= leftPaddleY + paddleHeight) {
                ctx.strokeStyle = 'rgba(255, 255, 255, 1)';
                ctx.lineWidth = 4;
                ctx.strokeRect(10, leftPaddleY, paddleWidth, paddleHeight);
            }

            if (!isPenaltyShot) {
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(canvas.width - 20, rightPaddleY, paddleWidth, paddleHeight);
                if (ballX >= canvas.width - 30 && ballX <= canvas.width - 20 && ballY + 10 >= rightPaddleY && ballY <= rightPaddleY + paddleHeight) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 1)';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(canvas.width - 20, rightPaddleY, paddleWidth, paddleHeight);
                }
            } else {
                if (goalieImage.complete && goalieImage.naturalWidth !== 0) {
                    ctx.drawImage(goalieImage, canvas.width - 20, goalY, paddleWidth, goalHeight);
                } else {
                    ctx.fillStyle = "#FF0000";
                    ctx.fillRect(canvas.width - 20, goalY, paddleWidth, goalHeight);
                }
            }

            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(ballX, ballY, 10, 10);

            drawHitParticles();

            ctx.font = '20px "Press Start 2P"';
            ctx.fillStyle = '#6CAEDF';
            ctx.textAlign = 'left';
            ctx.fillText(isPenaltyShot ? `Goals: ${leftScore}` : `${leftScore}`, 50, 50);
            ctx.textAlign = 'right';
            ctx.fillText(isPenaltyShot ? `Misses: ${misses}` : `${rightScore}`, canvas.width - 50, 50);

            if (hatTrickFlashTime > 0) {
                ctx.font = '40px "Press Start 2P"';
                ctx.fillStyle = (Math.sin(Date.now() / 100) > 0) ? '#6CAEDF' : '#FFFFFF';
                ctx.textAlign = 'center';
                ctx.fillText("HAT TRICK!", canvas.width / 2, canvas.height / 2);
            } else if (goalFlashTime > 0) {
                ctx.font = '40px "Press Start 2P"';
                ctx.fillStyle = `rgba(255, 255, 255, ${Math.sin(Date.now() / 100)})`;
                ctx.textAlign = 'center';
                ctx.fillText("GOAL!", canvas.width / 2, canvas.height / 2);
            }

            if (!isPenaltyShot && (leftScore >= winningScore || rightScore >= winningScore)) {
                gameRunning = false;
                clearInterval(speedIncreaseInterval);
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('victoryScreen').style.display = 'flex';
                const winner = leftScore >= winningScore ? player1Character : player2Character;
                document.getElementById('victoryMessage').textContent = `${winner.name} WINS!`;
                document.getElementById('victoryIcon').src = winner.imgSrc;
                clearButtonGlow();
                playVictoryMusic();
                createConfetti();
                animateVictoryText(); // Start flashing the victory text
                hitParticles = [];
            } else if (isPenaltyShot && (leftScore >= 3 || misses >= 3)) {
                gameRunning = false;
                document.getElementById('gameContainer').style.display = 'none';
                document.getElementById('victoryScreen').style.display = 'flex';
                document.getElementById('victoryMessage').textContent = leftScore >= 3 ? `${player1Character.name} WINS!` : "YOU LOSE!";
                document.getElementById('victoryIcon').src = player1Character.imgSrc;
                clearButtonGlow();
                playVictoryMusic();
                if (leftScore >= 3) createConfetti();
                animateVictoryText(); // Start flashing the victory text
                hitParticles = [];
            } else {
                requestAnimationFrame(gameLoop);
            }
        }

        playMainMenuMusic();
    </script>
</body>
</html>
